stages:
  - mirror
  # - build-and-push-backend-to-test
  - build-and-push-frontend-to-test
  # - build-and-push-backend-to-prod
  # - build-and-push-frontend-to-prod

variables:
  DOCKER_IMAGE_BACKEND: foryouhq/foryou-server
  DOCKER_IMAGE_FRONTEND: foryouhq/foryou-frontend

mirror_to_github:
  stage: mirror
  image: maven:3-eclipse-temurin-17
  script:
  - git config --global user.email "contactforyouhq@gmail.com"
  - git config --global user.name "ForyouHQ"

  - git clone https://oauth2:$MOHANED_TOKEN@gitlab.fdmci.hva.nl/se-specialization-2023-2/projects-tse1/ewamon/foryou
  - cd foryou

  - git remote rename origin gitlab
  - git remote add github https://oauth2:$GITHUB_MOHANED_TOKEN@github.com/ForyouHQ/Foryou.git

  - git fetch gitlab main
  - git checkout main
  - git pull gitlab main
  - git fetch github main
  - git merge github/main
  - git push github main

  - git fetch gitlab develop
  - git checkout develop
  - git pull gitlab develop
  - git fetch github develop
  - git merge github/develop
  - git push github develop
  only:
    - main
    - develop
  tags:
    - hva

# build-and-push-backend-to-test:
#   stage: build-and-push-backend-to-test
#   image: docker:stable
#   script:
#     - apk --no-cache add curl
#     - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
#     - cd foryou-server
#     - docker build --tag $DOCKER_IMAGE_BACKEND .
#     - docker push $DOCKER_IMAGE_BACKEND
#     - curl -s $RENDER_DEPLOY_HOOK_URL_BACKEND_TEST -o file.txt >/dev/null 2>&1
#   only:
#     - develop
#   tags:
#     - hva  

build-and-push-frontend-to-test:
  stage: build-and-push-frontend-to-test
  image: docker:stable
  script:
    - apk --no-cache add curl
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - cd foryou-frontend
    - docker build --tag $DOCKER_IMAGE_FRONTEND .
    - docker push $DOCKER_IMAGE_FRONTEND
    - curl -s $RENDER_DEPLOY_HOOK_URL_FRONTEND_TEST -o file.txt >/dev/null 2>&1
  only:
    - develop
  tags:
    - hva

# build-and-push-backend-to-prod:
#   stage: build-and-push-backend-to-prod
#   image: docker:stable
#   script:
#     - apk --no-cache add curl
#     - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
#     - cd foryou-frontend
#     - docker build --tag $DOCKER_IMAGE_FRONTEND .
#     - docker push $DOCKER_IMAGE_FRONTEND
#     - curl -s $RENDER_DEPLOY_HOOK_URL_FRONTEND_TEST -o file.txt >/dev/null 2>&1
#   only:
#     - main
#   tags:
#     - hva 

# build-and-push-frontend-to-prod:
#   stage: build-and-push-frontend-to-prod
#   image: docker:stable
#   script:
#     - apk --no-cache add curl
#     - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
#     - cd foryou-frontend
#     - docker build --tag $DOCKER_IMAGE_FRONTEND .
#     - docker push $DOCKER_IMAGE_FRONTEND
#     - curl -s $RENDER_DEPLOY_HOOK_URL_FRONTEND_TEST -o file.txt >/dev/null 2>&1
#   only:
#     - main
#   tags:
#     - hva               